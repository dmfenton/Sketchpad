name: Release

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:
    inputs:
      version:
        description: 'Version override (e.g., 1.0.0)'
        required: false
        type: string

env:
  AWS_REGION: us-east-1
  ECR_REPOSITORY: drawing-agent

jobs:
  build-and-release:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Extract version from tag
        id: version
        run: |
          if [ -n "${{ inputs.version }}" ]; then
            VERSION="${{ inputs.version }}"
          elif [[ "$GITHUB_REF" == refs/tags/v* ]]; then
            VERSION="${GITHUB_REF#refs/tags/v}"
          else
            VERSION="0.0.0"
          fi
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "tag=v$VERSION" >> $GITHUB_OUTPUT

      - name: Build web frontend
        env:
          VERSION: ${{ steps.version.outputs.version }}
        run: |
          npm ci
          npm run build -w shared
          npm run build -w web
          # Write version file for nginx to serve
          echo "$VERSION" > web/dist/version.txt
          echo "Web frontend built successfully (v$VERSION)"
          ls -la web/dist/

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Login to Amazon ECR
        id: login-ecr
        uses: aws-actions/amazon-ecr-login@v2

      - name: Build, tag, and push image to Amazon ECR
        id: build
        env:
          ECR_REGISTRY: ${{ steps.login-ecr.outputs.registry }}
          VERSION: ${{ steps.version.outputs.version }}
        run: |
          # Get build metadata
          COMMIT_SHA="${GITHUB_SHA:0:7}"
          BUILD_TIME=$(date -u +"%Y-%m-%dT%H:%M:%SZ")

          # Build the image with version info
          docker build \
            --build-arg APP_VERSION="$VERSION" \
            --build-arg APP_COMMIT="$COMMIT_SHA" \
            --build-arg APP_BUILD_TIME="$BUILD_TIME" \
            -t $ECR_REGISTRY/$ECR_REPOSITORY:v$VERSION \
            ./server
          docker tag $ECR_REGISTRY/$ECR_REPOSITORY:v$VERSION $ECR_REGISTRY/$ECR_REPOSITORY:latest

          # Push both tags
          docker push $ECR_REGISTRY/$ECR_REPOSITORY:v$VERSION
          docker push $ECR_REGISTRY/$ECR_REPOSITORY:latest

          echo "image=$ECR_REGISTRY/$ECR_REPOSITORY:v$VERSION" >> $GITHUB_OUTPUT

      - name: Sync deploy configs and web build to S3
        run: |
          ACCOUNT_ID=$(aws sts get-caller-identity --query Account --output text)
          BUCKET="drawing-agent-config-${ACCOUNT_ID}"

          echo "Syncing deploy/ to s3://${BUCKET}/deploy/"
          aws s3 sync deploy/ "s3://${BUCKET}/deploy/" --delete

          echo "Syncing web build to s3://${BUCKET}/deploy/web/"
          aws s3 sync web/dist/ "s3://${BUCKET}/deploy/web/" --delete

      - name: Extract changelog
        id: changelog
        run: |
          VERSION="${{ steps.version.outputs.version }}"

          # Extract this version's section from CHANGELOG.md
          # Matches from "## [X.Y.Z]" until the next "## [" or end of file
          CHANGELOG=$(awk "/^## \\[$VERSION\\]/{flag=1; next} /^## \\[/{flag=0} flag" CHANGELOG.md)

          if [ -z "$CHANGELOG" ]; then
            echo "No changelog entry found for v$VERSION, using git log"
            PREV_TAG=$(git describe --tags --abbrev=0 HEAD^ 2>/dev/null || echo "")
            if [ -n "$PREV_TAG" ]; then
              CHANGELOG=$(git log $PREV_TAG..HEAD --pretty=format:"- %s (%h)" --no-merges)
            else
              CHANGELOG=$(git log -20 --pretty=format:"- %s (%h)" --no-merges)
            fi
          fi

          # Write to output using delimiter
          echo "changelog<<EOF" >> $GITHUB_OUTPUT
          echo "$CHANGELOG" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ steps.version.outputs.tag }}
          name: Release ${{ steps.version.outputs.tag }}
          body: |
            ## Docker Image

            ```
            ${{ steps.login-ecr.outputs.registry }}/${{ env.ECR_REPOSITORY }}:v${{ steps.version.outputs.version }}
            ```

            ## Changes

            ${{ steps.changelog.outputs.changelog }}

            ## Deployment

            - **Server**: Watchtower auto-deploys within 30 seconds
            - **iOS**: TestFlight build triggered (see Actions tab)
          draft: false
          prerelease: ${{ contains(steps.version.outputs.version, '-') }}

      - name: Wait for deployment
        env:
          VERSION: ${{ steps.version.outputs.version }}
        run: |
          echo "Waiting for Watchtower to deploy v$VERSION..."

          # Wait up to 2 minutes for deployment
          for i in {1..24}; do
            sleep 5

            # Check /api/version endpoint
            RESPONSE=$(curl -sf https://monet.dmfenton.net/api/version 2>/dev/null || echo '{}')
            DEPLOYED_VERSION=$(echo "$RESPONSE" | jq -r '.version // empty')

            if [ "$DEPLOYED_VERSION" = "$VERSION" ]; then
              echo "✅ Deployment verified: v$VERSION is running"
              echo "Response: $RESPONSE"
              exit 0
            fi

            echo "Attempt $i/24: Current version is '${DEPLOYED_VERSION:-unknown}', waiting for '$VERSION'..."
          done

          echo "❌ Deployment verification failed after 2 minutes"
          echo "Expected: $VERSION"
          echo "Got: $DEPLOYED_VERSION"
          exit 1

      - name: Summary
        env:
          ECR_REGISTRY: ${{ steps.login-ecr.outputs.registry }}
          VERSION: ${{ steps.version.outputs.version }}
        run: |
          echo "## Release Summary" >> $GITHUB_STEP_SUMMARY
          echo "- **Version**: v$VERSION" >> $GITHUB_STEP_SUMMARY
          echo "- **Image**: \`$ECR_REGISTRY/$ECR_REPOSITORY:v$VERSION\`" >> $GITHUB_STEP_SUMMARY
          echo "- **Deployment**: ✅ Verified running at https://monet.dmfenton.net/api/version" >> $GITHUB_STEP_SUMMARY
          echo "- **iOS**: TestFlight build triggered" >> $GITHUB_STEP_SUMMARY
