name: Release

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:
    inputs:
      version:
        description: 'Version override (e.g., 1.0.0)'
        required: false
        type: string

env:
  AWS_REGION: us-east-1
  ECR_REPOSITORY: drawing-agent
  ECR_SSR_REPOSITORY: web-ssr

jobs:
  build-and-release:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Extract version from tag
        id: version
        run: |
          if [ -n "${{ inputs.version }}" ]; then
            VERSION="${{ inputs.version }}"
          elif [[ "$GITHUB_REF" == refs/tags/v* ]]; then
            VERSION="${GITHUB_REF#refs/tags/v}"
          else
            VERSION="0.0.0"
          fi
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "tag=v$VERSION" >> $GITHUB_OUTPUT

      # Run E2E SDK tests before deploying to catch breaking changes
      - name: Install uv
        uses: astral-sh/setup-uv@v4
        with:
          version: 'latest'

      - name: Set up Python
        run: uv python install 3.11

      - name: Install server dependencies
        working-directory: server
        run: uv sync --extra dev

      - name: Run E2E SDK tests
        working-directory: server
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
        run: uv run pytest -m e2e tests/test_e2e_sdk.py -v

      - name: Build web frontend
        env:
          VERSION: ${{ steps.version.outputs.version }}
          VITE_UMAMI_WEBSITE_ID: ${{ secrets.UMAMI_WEBSITE_ID }}
        run: |
          npm ci
          npm run build -w shared
          npm run build -w web
          # Write version file for nginx to serve
          echo "$VERSION" > web/dist/version.txt
          echo "Web frontend built successfully (v$VERSION)"
          ls -la web/dist/

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Login to Amazon ECR
        id: login-ecr
        uses: aws-actions/amazon-ecr-login@v2

      - name: Build, tag, and push backend image to Amazon ECR
        id: build
        env:
          ECR_REGISTRY: ${{ steps.login-ecr.outputs.registry }}
          VERSION: ${{ steps.version.outputs.version }}
        run: |
          # Get build metadata
          COMMIT_SHA="${GITHUB_SHA:0:7}"
          BUILD_TIME=$(date -u +"%Y-%m-%dT%H:%M:%SZ")

          # Build the image with version info
          docker build \
            --build-arg APP_VERSION="$VERSION" \
            --build-arg APP_COMMIT="$COMMIT_SHA" \
            --build-arg APP_BUILD_TIME="$BUILD_TIME" \
            -t $ECR_REGISTRY/$ECR_REPOSITORY:v$VERSION \
            ./server
          docker tag $ECR_REGISTRY/$ECR_REPOSITORY:v$VERSION $ECR_REGISTRY/$ECR_REPOSITORY:latest

          # Push both tags
          docker push $ECR_REGISTRY/$ECR_REPOSITORY:v$VERSION
          docker push $ECR_REGISTRY/$ECR_REPOSITORY:latest

          echo "image=$ECR_REGISTRY/$ECR_REPOSITORY:v$VERSION" >> $GITHUB_OUTPUT

      - name: Build, tag, and push SSR image to Amazon ECR
        id: build-ssr
        env:
          ECR_REGISTRY: ${{ steps.login-ecr.outputs.registry }}
          VERSION: ${{ steps.version.outputs.version }}
        run: |
          # Build the SSR image
          docker build \
            --build-arg VERSION="$VERSION" \
            -t $ECR_REGISTRY/$ECR_SSR_REPOSITORY:v$VERSION \
            -f web/Dockerfile \
            .
          docker tag $ECR_REGISTRY/$ECR_SSR_REPOSITORY:v$VERSION $ECR_REGISTRY/$ECR_SSR_REPOSITORY:latest

          # Push both tags
          docker push $ECR_REGISTRY/$ECR_SSR_REPOSITORY:v$VERSION
          docker push $ECR_REGISTRY/$ECR_SSR_REPOSITORY:latest

          echo "image=$ECR_REGISTRY/$ECR_SSR_REPOSITORY:v$VERSION" >> $GITHUB_OUTPUT

      - name: Sync deploy configs and web build to S3
        env:
          ADMIN_IP: ${{ secrets.ADMIN_IP }}
        run: |
          ACCOUNT_ID=$(aws sts get-caller-identity --query Account --output text)
          BUCKET="drawing-agent-config-${ACCOUNT_ID}"

          # Substitute ADMIN_IP in nginx.conf
          if [ -n "$ADMIN_IP" ]; then
            echo "Substituting ADMIN_IP in nginx.conf..."
            sed -i "s/\${ADMIN_IP}/$ADMIN_IP/g" deploy/nginx.conf
          else
            echo "Warning: ADMIN_IP secret not set, nginx.conf will have placeholder"
          fi

          echo "Syncing deploy/ to s3://${BUCKET}/deploy/"
          aws s3 sync deploy/ "s3://${BUCKET}/deploy/" --delete

          echo "Syncing web build to s3://${BUCKET}/deploy/web/"
          aws s3 sync web/dist/ "s3://${BUCKET}/deploy/web/" --delete

      - name: Run database migrations
        env:
          ECR_REGISTRY: ${{ steps.login-ecr.outputs.registry }}
          VERSION: ${{ steps.version.outputs.version }}
        run: |
          echo "Running database migrations with new image..."

          # Get EC2 instance ID
          INSTANCE_ID=$(aws ec2 describe-instances \
            --filters "Name=tag:Name,Values=drawing-agent" "Name=instance-state-name,Values=running" \
            --query "Reservations[0].Instances[0].InstanceId" \
            --output text)

          if [ "$INSTANCE_ID" = "None" ] || [ -z "$INSTANCE_ID" ]; then
            echo "❌ Could not find running EC2 instance"
            exit 1
          fi

          echo "Found instance: $INSTANCE_ID"

          # Run migration in a one-off container
          # Fetch DATABASE_URL from SSM to pass to the container (container can't access SSM directly)
          DATABASE_URL=$(aws ssm get-parameter --name "/code-monet/prod/database-url" --with-decryption --query 'Parameter.Value' --output text 2>/dev/null || echo "")

          COMMAND_ID=$(aws ssm send-command \
            --instance-ids "$INSTANCE_ID" \
            --document-name "AWS-RunShellScript" \
            --parameters "commands=[
              \"echo 'Pulling new image...'\",
              \"docker pull $ECR_REGISTRY/$ECR_REPOSITORY:v$VERSION\",
              \"echo 'Running migrations...'\",
              \"docker run --rm -v /home/ec2-user/data:/app/data -e CODE_MONET_ENV=prod -e AWS_REGION=us-east-1 -e DATABASE_URL='$DATABASE_URL' $ECR_REGISTRY/$ECR_REPOSITORY:v$VERSION uv run alembic upgrade head\",
              \"echo 'Migrations complete'\"
            ]" \
            --query "Command.CommandId" \
            --output text)

          echo "SSM Command ID: $COMMAND_ID"

          # Wait for command to complete
          for i in {1..30}; do
            sleep 5
            STATUS=$(aws ssm get-command-invocation \
              --command-id "$COMMAND_ID" \
              --instance-id "$INSTANCE_ID" \
              --query "Status" \
              --output text 2>/dev/null || echo "Pending")

            echo "Attempt $i/30: Migration status: $STATUS"

            if [ "$STATUS" = "Success" ]; then
              echo "✅ Migrations completed successfully"
              # Show output
              aws ssm get-command-invocation \
                --command-id "$COMMAND_ID" \
                --instance-id "$INSTANCE_ID" \
                --query "StandardOutputContent" \
                --output text
              break
            elif [ "$STATUS" = "Failed" ] || [ "$STATUS" = "Cancelled" ] || [ "$STATUS" = "TimedOut" ]; then
              echo "❌ Migration failed with status: $STATUS"
              aws ssm get-command-invocation \
                --command-id "$COMMAND_ID" \
                --instance-id "$INSTANCE_ID" \
                --query "StandardErrorContent" \
                --output text
              exit 1
            fi
          done

          if [ "$STATUS" != "Success" ]; then
            echo "❌ Migration timed out"
            exit 1
          fi

      - name: Extract changelog
        id: changelog
        run: |
          VERSION="${{ steps.version.outputs.version }}"

          # Extract this version's section from CHANGELOG.md
          # Matches from "## [X.Y.Z]" until the next "## [" or end of file
          CHANGELOG=$(awk "/^## \\[$VERSION\\]/{flag=1; next} /^## \\[/{flag=0} flag" CHANGELOG.md)

          if [ -z "$CHANGELOG" ]; then
            echo "No changelog entry found for v$VERSION, using git log"
            PREV_TAG=$(git describe --tags --abbrev=0 HEAD^ 2>/dev/null || echo "")
            if [ -n "$PREV_TAG" ]; then
              CHANGELOG=$(git log $PREV_TAG..HEAD --pretty=format:"- %s (%h)" --no-merges)
            else
              CHANGELOG=$(git log -20 --pretty=format:"- %s (%h)" --no-merges)
            fi
          fi

          # Write to output using delimiter
          echo "changelog<<EOF" >> $GITHUB_OUTPUT
          echo "$CHANGELOG" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ steps.version.outputs.tag }}
          name: Release ${{ steps.version.outputs.tag }}
          body: |
            ## Docker Images

            **Backend API:**
            ```
            ${{ steps.login-ecr.outputs.registry }}/${{ env.ECR_REPOSITORY }}:v${{ steps.version.outputs.version }}
            ```

            **Web SSR Server:**
            ```
            ${{ steps.login-ecr.outputs.registry }}/${{ env.ECR_SSR_REPOSITORY }}:v${{ steps.version.outputs.version }}
            ```

            ## Changes

            ${{ steps.changelog.outputs.changelog }}

            ## Deployment

            - **Server**: Deployed via SSM (explicit docker-compose restart)
            - **iOS**: TestFlight build triggered (see Actions tab)
          draft: false
          prerelease: ${{ contains(steps.version.outputs.version, '-') }}

      - name: Deploy to production
        env:
          ECR_REGISTRY: ${{ steps.login-ecr.outputs.registry }}
          VERSION: ${{ steps.version.outputs.version }}
        run: |
          echo "Deploying v$VERSION to production..."

          # Get EC2 instance ID
          INSTANCE_ID=$(aws ec2 describe-instances \
            --filters "Name=tag:Name,Values=drawing-agent" "Name=instance-state-name,Values=running" \
            --query "Reservations[0].Instances[0].InstanceId" \
            --output text)

          if [ "$INSTANCE_ID" = "None" ] || [ -z "$INSTANCE_ID" ]; then
            echo "❌ Could not find running EC2 instance"
            exit 1
          fi

          echo "Found instance: $INSTANCE_ID"

          # Get S3 bucket name for config sync
          ACCOUNT_ID=$(aws sts get-caller-identity --query Account --output text)
          CONFIG_BUCKET="drawing-agent-config-${ACCOUNT_ID}"

          # Deploy: sync config, update IMAGE_TAG, pull new images, restart containers
          COMMAND_ID=$(aws ssm send-command \
            --instance-ids "$INSTANCE_ID" \
            --document-name "AWS-RunShellScript" \
            --parameters "commands=[
              \"cd /home/ec2-user\",
              \"echo 'Syncing deploy config from S3...'\",
              \"aws s3 sync s3://${CONFIG_BUCKET}/deploy/ . --exclude 'web/*' --exclude 'data/*'\",
              \"echo 'Setting IMAGE_TAG=v$VERSION and ECR_REGISTRY'\",
              \"sed -i '/^IMAGE_TAG=/d' .env 2>/dev/null || true\",
              \"sed -i '/^ECR_REGISTRY=/d' .env 2>/dev/null || true\",
              \"echo 'IMAGE_TAG=v$VERSION' >> .env\",
              \"echo 'ECR_REGISTRY=$ECR_REGISTRY' >> .env\",
              \"echo 'Re-authenticating with ECR...'\",
              \"aws ecr get-login-password --region $AWS_REGION | docker login --username AWS --password-stdin $ECR_REGISTRY\",
              \"echo 'Pulling new images...'\",
              \"docker pull $ECR_REGISTRY/$ECR_REPOSITORY:v$VERSION\",
              \"docker pull $ECR_REGISTRY/$ECR_SSR_REPOSITORY:v$VERSION\",
              \"echo 'Restarting containers...'\",
              \"docker-compose -f docker-compose.prod.yml up -d --force-recreate drawing-agent web-ssr nginx\",
              \"echo 'Waiting for containers to be healthy...'\",
              \"sleep 10\",
              \"docker ps | grep -E 'drawing-agent|web-ssr'\"
            ]" \
            --query "Command.CommandId" \
            --output text)

          echo "SSM Command ID: $COMMAND_ID"

          # Wait for deployment command to complete
          for i in {1..30}; do
            sleep 5
            STATUS=$(aws ssm get-command-invocation \
              --command-id "$COMMAND_ID" \
              --instance-id "$INSTANCE_ID" \
              --query "Status" \
              --output text 2>/dev/null || echo "Pending")

            echo "Attempt $i/30: Deployment status: $STATUS"

            if [ "$STATUS" = "Success" ]; then
              echo "✅ Deployment command completed"
              aws ssm get-command-invocation \
                --command-id "$COMMAND_ID" \
                --instance-id "$INSTANCE_ID" \
                --query "StandardOutputContent" \
                --output text
              break
            elif [ "$STATUS" = "Failed" ] || [ "$STATUS" = "Cancelled" ] || [ "$STATUS" = "TimedOut" ]; then
              echo "❌ Deployment failed with status: $STATUS"
              aws ssm get-command-invocation \
                --command-id "$COMMAND_ID" \
                --instance-id "$INSTANCE_ID" \
                --query "StandardErrorContent" \
                --output text
              exit 1
            fi
          done

          if [ "$STATUS" != "Success" ]; then
            echo "❌ Deployment timed out"
            exit 1
          fi

      - name: Verify deployment
        env:
          VERSION: ${{ steps.version.outputs.version }}
        run: |
          echo "Verifying v$VERSION is running..."

          # Wait up to 1 minute for both backend and SSR to be healthy
          for i in {1..12}; do
            sleep 5

            # Check backend version
            RESPONSE=$(curl -sf https://monet.dmfenton.net/api/version 2>/dev/null || echo '{}')
            DEPLOYED_VERSION=$(echo "$RESPONSE" | jq -r '.version // empty')

            # Check SSR health
            SSR_RESPONSE=$(curl -sf https://monet.dmfenton.net/ssr-health 2>/dev/null || echo '{}')
            SSR_STATUS=$(echo "$SSR_RESPONSE" | jq -r '.status // empty')

            if [ "$DEPLOYED_VERSION" = "$VERSION" ] && [ "$SSR_STATUS" = "healthy" ]; then
              echo "✅ Backend deployed: v$VERSION"
              echo "✅ SSR status: $SSR_STATUS"
              exit 0
            fi

            echo "Attempt $i/12: Backend='${DEPLOYED_VERSION:-unknown}' (want '$VERSION'), SSR='${SSR_STATUS:-unknown}' (want 'healthy')"
          done

          echo "❌ Deployment verification failed after 1 minute"
          echo "Expected backend: $VERSION, got: $DEPLOYED_VERSION"
          echo "Expected SSR: healthy, got: $SSR_STATUS"
          exit 1

      - name: Cleanup old Docker images
        run: |
          echo "Cleaning up old Docker images on EC2..."

          INSTANCE_ID=$(aws ec2 describe-instances \
            --filters "Name=tag:Name,Values=drawing-agent" "Name=instance-state-name,Values=running" \
            --query "Reservations[0].Instances[0].InstanceId" \
            --output text)

          aws ssm send-command \
            --instance-ids "$INSTANCE_ID" \
            --document-name "AWS-RunShellScript" \
            --parameters 'commands=["docker system prune -af --filter until=24h && df -h /"]' \
            --comment "Post-deploy Docker cleanup"

          echo "✅ Cleanup command sent (runs async)"

      - name: Summary
        env:
          ECR_REGISTRY: ${{ steps.login-ecr.outputs.registry }}
          VERSION: ${{ steps.version.outputs.version }}
        run: |
          echo "## Release Summary" >> $GITHUB_STEP_SUMMARY
          echo "- **Version**: v$VERSION" >> $GITHUB_STEP_SUMMARY
          echo "- **Backend Image**: \`$ECR_REGISTRY/$ECR_REPOSITORY:v$VERSION\`" >> $GITHUB_STEP_SUMMARY
          echo "- **SSR Image**: \`$ECR_REGISTRY/$ECR_SSR_REPOSITORY:v$VERSION\`" >> $GITHUB_STEP_SUMMARY
          echo "- **Deployment**: ✅ Verified running at https://monet.dmfenton.net/api/version" >> $GITHUB_STEP_SUMMARY
          echo "- **iOS**: TestFlight build triggered" >> $GITHUB_STEP_SUMMARY
